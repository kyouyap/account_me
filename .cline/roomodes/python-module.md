---
name: Python:Module
groups:
  - read
  - edit
  - browser
  - command
  - mcp
source: "project"
---

## 実装モード: モジュールモード

モジュールモードでは、複数のファイルで構成されたパッケージを対象とし、内部実装と公開インターフェースを明確に分離します。以下の例は、ディレクトリ構成と各ファイルの役割について説明しています。

### 例: ディレクトリ構成

```
xxx/                     # モジュール xxx パッケージ
  __init__.py           # 公開インターフェース。lib.py からの関数やクラスの再エクスポートのみを行う。
  deps.py               # 他の外部モジュールのインポートを集約し、内部で使用する機能を re-export する。
  lib.py                # 実装コード。deps.py から import したものを利用して実装を行う。
  types.py              # 型定義や定数など、モジュール内で使用する型情報を集約する。
  test_module.py        # __init__.py の公開インターフェースに対するテストコード。
  test_lib.py           # lib.py の実装に対するテストコード。
yyy/                     # 別モジュール yyy も同様の構成
  __init__.py
  deps.py
  lib.py
  types.py
  test_module.py
  test_lib.py
```

### 各ファイルの役割

- **`__init__.py`:**  
  - モジュールのパブリックインターフェースを定義します。  
  - 内部実装（lib.py）の詳細は隠蔽し、必要な関数やクラスだけを再エクスポートします。  
  - 他モジュールは必ずこのファイル経由で参照し、直接 lib.py など内部ファイルを import してはいけません。

- **`deps.py`:**  
  - 外部依存関係（例: requests, numpy など）のインポートをまとめ、モジュール内で共通利用できるように再エクスポートします。  
  - このファイルを見るだけで、モジュールが依存している外部ライブラリを把握できます。

- **`types.py`:**  
  - モジュール内で使用する型定義（PEP 484 に基づく型ヒントや NamedTuple、dataclass など）を集約します。  
  - 複雑な型定義はここで管理し、他ファイルからも参照できるようにします。

- **`lib.py`:**  
  - モジュールの実装コードを担当します。  
  - 内部では必ず deps.py からインポートした依存関係を使用し、外部からの直接参照はさせません。  
  - コード量が少ない場合はこのファイル内で実装してもよいですが、実装量が多い場合は適宜複数ファイルに分割します。

- **テストファイル (`test_module.py`, `test_lib.py`):**  
  - 各実装ファイルに対して、1:1 で対応するテストコードを作成します。  
  - テストは、パッケージルートまたは同一ディレクトリに配置し、`pytest` コマンドで実行します。  
  - 例:  
    ```bash
    pytest xxx/test_module.py
    ```

### テストの実行とデバッグ

- モジュール全体のテストは、例えば以下のように実行します：
  ```bash
  pytest --maxfail=1 --disable-warnings -q
  ```
- 特定のテストファイルだけ実行する場合：
  ```bash
  pytest xxx/test_lib.py
  ```
- テストが落ちた場合は、落ちたテストの内容を確認し、次の手順で進めます：
  1. 全体テストを実行して、問題の箇所を特定する。
  2. 問題のテストファイルのみ実行し、失敗原因をステップバイステップで検証する（プリントデバッグなどを併用）。
  3. 必要ならば、修正後に再度モジュール全体のテストを確認する。

### 依存管理と外部参照

- Python 版モジュールでは、外部ライブラリは `uv add ` によって管理され、依存関係は `pyproject.toml` や `requirements.txt` に記述します。  
- 他のモジュールや外部ライブラリを参照する際は、直接ファイルを指定するのではなく、パッケージ管理ツール（uv や pip）を通じて管理し、`__init__.py` 経由で公開することを推奨します。  
- 例：  
  - **OK:**  
    ```python
    from requests import get
    ```
  - **NG:**  
    ```python
    from some_internal_path.requests import get
    ```

このような構造により、モジュール間の依存関係が明確になり、変更影響範囲が予測しやすく、リファクタリングもしやすくなります。

